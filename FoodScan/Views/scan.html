<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Product Barcode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        #interactive {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        form {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        input[type="text"] {
            padding: 10px;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        #result {
            margin-top: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .loading {
            text-align: center;
            font-size: 18px;
            color: #007bff; /* Bootstrap primary color */
        }
        .error-message {
            color: red;
        }
    </style>
</head>
<body>

<h1>Scan Product Barcode</h1>

<div id="interactive"></div>

<form id="barcodeForm">
    <input type="text" id="barcode" placeholder="Scanned Barcode" readonly required>
    <button type="submit">Submit</button>
</form>

<div id="result"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize QuaggaJS
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: {
                facingMode: "environment" // Use the back camera
            }
        },
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "code_39_vin_reader",
                "codabar_reader",
                "upc_reader",
                "upc_e_reader",
                "i2of5_reader",
                "2of5_reader",
                "code_93_reader"
            ]
        }
    }, function(err) {
        if (err) {
            console.error("Initialization error:", err);
            return; // Handle initialization error silently
        }
        console.log("Initialization finished. Ready to start.");
        Quagga.start();
    });

    // Processed event handler
    Quagga.onProcessed(function(result) {
        const drawingCtx = Quagga.canvas.ctx.overlay,
              drawingCanvas = Quagga.canvas.dom.overlay;

        if (result) {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            
            if (result.boxes) {
                result.boxes.filter(box => box !== result.box).forEach(box => {
                    Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "green", lineWidth: 2 });
                });
            }

            if (result.box) {
                Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#00F", lineWidth: 2 });
            }

            if (result.codeResult && result.codeResult.code) {
                Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, { color: 'red', lineWidth: 3 });
                
                // Automatically fill the barcode input field with the scanned code
                document.getElementById('barcode').value = result.codeResult.code; 
                
                // Stop scanning after a successful scan
                Quagga.stop();
                
                // Trigger form submission
                document.getElementById('barcodeForm').dispatchEvent(new Event('submit'));
            }
        }
    });

    // Detected event handler
    async function fetchProductData(barcode) {
        const resultDiv = document.getElementById('result');
        
        // Show loading message
        resultDiv.innerHTML = '<div class="loading">Loading product data...</div>';

        try {
            const response = await fetch('http://127.0.0.1:3000/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ barcode })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Network response was not ok");
            }

            const productData = await response.json();
            
            displayProductDetails(productData);
        } catch (error) {
            console.error('Error fetching product data:', error);
            
            // Display error message in a user-friendly way
            resultDiv.innerHTML = `<div class="error-message">Error fetching product data. ${error.message}</div>`;
        }
    }

    // Handle manual barcode form submission
    document.getElementById('barcodeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const barcode = document.getElementById('barcode').value;

        if (!barcode) return;

        await fetchProductData(barcode);
    });

    // Function to display product information
    function displayProductDetails(data) {
        const resultDiv = document.getElementById('result');
        
        resultDiv.innerHTML = `
          <h2>Product Details:</h2>
          <p><strong>Product Name:</strong> ${data.product_name || 'N/A'}</p>
          <p><strong>Brands:</strong> ${data.brands || 'N/A'}</p>
          <p><strong>Ingredients:</strong> ${data.ingredients_text || 'N/A'}</p>
          <h3>Nutritional Information:</h3>
          <ul>
              <li>Energy: ${data.nutriments.energy || '0'} ${data.nutriments.energy_unit || ''}</li>
              <li>Fat: ${data.nutriments.fat || '0'} g</li>
              <li>Saturated Fat: ${data.nutriments.saturated_fat || '0'} g</li>
              <li>Carbohydrates: ${data.nutriments.carbohydrates || '0'} g</li>
              <li>Sugars: ${data.nutriments.sugars || '0'} g</li>
              <li>Proteins: ${data.nutriments.proteins || '0'} g</li>
              <li>Salt: ${data.nutriments.salt || '0'} g</li>
              <li>Sodium: ${data.nutriments.sodium || '0'} g</li>
          </ul>
          ${data.image_url ? `<img src="${data.image_url}" alt="Product Image" style="max-width:100%; height:auto;"/>` : ''}
      `;
    }
});
</script>

</body>
</html>